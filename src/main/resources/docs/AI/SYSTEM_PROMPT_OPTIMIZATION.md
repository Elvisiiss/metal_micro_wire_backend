# 系统提示词优化文档

## 优化概述

针对AI助手在处理复杂任务时出现的工具调用错误问题，对DeepSeekConfig中的系统提示词进行了全面优化，提高了AI助手的工具调用准确性和智能性。

## 问题分析

### 原始问题
用户请求"分析今天的设备检测数据，给我今天的检测数据"时，AI助手尝试调用了不存在的工具函数`get_detection_data`，而不是正确的工具组合。

### 根本原因
1. **工具函数描述不够详细**：原系统提示词只有简单的功能分类，缺乏具体的工具函数列表
2. **缺乏多步骤指导**：没有明确的多步骤任务执行策略
3. **工具组合示例不足**：缺乏常见任务的工具组合示例
4. **约束条件不明确**：没有明确禁止调用不存在的工具

## 优化内容

### 1. 详细的工具函数清单

**优化前**：
```
1. **设备管理**：查询设备状态、设备列表等信息
2. **线材检测数据**：查询金属微丝的检测数据、质量参数等
```

**优化后**：
```
### 1. 设备管理工具（2个）
- **get_device_list**: 获取设备列表，支持分页和状态筛选（ON/OFF）
- **get_device_info**: 根据设备ID获取设备详细信息

### 2. 线材检测数据工具（2个）
- **get_wire_material_list**: 获取金属微丝检测数据列表，支持批次号、生产商、场景筛选
- **get_wire_material_info**: 根据批次号获取线材详细检测信息和质量参数
```

### 2. 多步骤分析流程指导

新增了明确的多步骤分析流程：
```
### 多步骤分析流程
当用户请求复杂分析时，按以下顺序组合工具：
1. **时间确定**：如涉及"今天"、"本月"等时间概念，先调用get_current_time获取准确时间
2. **数据收集**：根据需求调用相应的数据获取工具（设备、线材、质量等）
3. **深度分析**：使用分析工具进行质量溯源、排名对比等
4. **统计汇总**：调用统计工具提供整体数据概览
```

### 3. 常见任务的工具组合示例

提供了具体的工具调用序列：
```
### 常见任务的工具组合
- **今日检测数据分析**：get_current_time → get_device_list → get_wire_material_list → get_overall_statistics
- **质量问题调查**：get_quality_issues → analyze_quality_issues → get_manufacturer_ranking
- **生产商评估**：get_manufacturer_ranking → analyze_quality_issues → get_wire_material_list
- **设备状态检查**：get_device_list → get_device_info → get_overall_statistics
- **时间范围分析**：get_current_time → get_scenario_statistics → get_yearly_statistics
```

### 4. 严格的约束条件

新增了明确的约束条件：
```
## 重要约束
- **严禁调用不存在的工具**：只能使用上述11个明确定义的工具函数
- **参数准确性**：确保传递给工具的参数格式正确，特别是时间格式（yyyy-MM-dd HH:mm:ss）
- **逐步执行**：复杂任务需要分步骤执行，不要尝试一次性获取所有数据
- **错误处理**：如果工具调用失败，提供替代方案或建议用户检查参数
```

### 5. 标准化响应模式

定义了5步响应模式：
```
## 响应模式
1. **理解需求**：准确理解用户的查询意图
2. **规划步骤**：确定需要调用的工具和执行顺序
3. **执行调用**：按计划逐步调用工具获取数据
4. **分析整合**：整合多个工具的结果进行综合分析
5. **提供建议**：基于数据分析提供专业建议和后续行动建议
```

## 优化效果

### 1. 工具调用准确性提升
- **明确工具清单**：AI助手现在知道确切有哪11个工具可用
- **禁止幻觉调用**：明确禁止调用不存在的工具函数
- **参数格式规范**：明确了参数格式要求，减少调用错误

### 2. 多步骤任务处理能力增强
- **流程化指导**：提供了清晰的多步骤执行流程
- **任务分解**：复杂任务被分解为可管理的步骤
- **工具组合优化**：预定义了常见任务的最佳工具组合

### 3. 用户体验改善
- **响应更智能**：AI助手能够更好地理解用户意图
- **分析更全面**：通过多工具组合提供更全面的分析
- **建议更专业**：基于实际数据提供更准确的建议

## 测试验证

### 单元测试覆盖
创建了`SystemPromptOptimizationTest`测试类，验证：
- 系统提示词包含所有11个工具函数
- 包含工具分类和多步骤策略
- 包含约束条件和响应模式
- 结构合理，长度适中

### 功能测试场景
针对原问题场景"分析今天的设备检测数据"，优化后的AI助手应该：
1. 调用`get_current_time`获取当前日期
2. 调用`get_device_list`获取设备列表
3. 调用`get_wire_material_list`获取今日线材检测数据
4. 调用`get_overall_statistics`获取统计数据
5. 整合分析结果并提供专业建议

## 配置同步

优化内容同时更新了两个配置位置：
1. **DeepSeekConfig.java**：代码中的默认配置
2. **application.yml**：外部配置文件

确保配置的一致性和可维护性。

## 后续改进建议

1. **动态工具发现**：考虑实现动态工具发现机制，自动更新系统提示词
2. **个性化提示**：根据用户角色和权限定制系统提示词
3. **性能监控**：监控工具调用成功率和响应时间
4. **用户反馈**：收集用户反馈，持续优化提示词内容
5. **A/B测试**：对比不同版本的系统提示词效果

## 维护指南

### 添加新工具时
1. 在工具函数清单中添加新工具描述
2. 更新工具总数统计
3. 添加相关的工具组合示例
4. 同步更新DeepSeekConfig.java和application.yml
5. 更新相关测试用例

### 修改现有工具时
1. 更新工具描述和参数说明
2. 修改相关的工具组合示例
3. 更新约束条件（如有必要）
4. 验证测试用例仍然通过

这次优化显著提升了AI助手的工具调用准确性和智能性，为用户提供更好的数据分析体验。
